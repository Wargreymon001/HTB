# üß† Enumeration Methodology ‚Äî versi√≥n combinada (explicada + t√©cnica)

> Meta: entender **qu√© existe**, **c√≥mo est√° protegido** y **c√≥mo funciona**, antes de intentar explotarlo. No damos nada por sentado: cada t√©rmino y paso se explica.

---

## ‚úÖ Conceptos clave (sin asumir conocimientos previos)
- **Enumeration (enumeraci√≥n):** recolectar informaci√≥n del objetivo. Puede ser **pasiva** (sin tocar el objetivo: buscadores, registros p√∫blicos) o **activa** (interactuando: escaneos, banners).
- **OSINT:** recolecci√≥n **solo pasiva**. No escanea ni toca el objetivo.
- **Metodolog√≠a:** un plan repetible para no saltarnos pasos. Aqu√≠ usamos **6 capas** y **3 niveles**.
- **Capa (layer):** un ‚Äúmuro‚Äù de informaci√≥n/seguridad que debemos comprender para avanzar.
- **Nivel:** d√≥nde aplicamos la enumeraci√≥n: **Infraestructura**, **Host** o **Sistema Operativo**.
- **Riesgo de ‚Äúruido‚Äù:** acciones como brute-force temprano pueden activar defensas (bloqueos/alertas) y arruinar la evaluaci√≥n.

---

## üß∞ Glosario m√≠nimo
- **Dominio/Subdominio:** nombres como `empresa.com` / `vpn.empresa.com` que apuntan a IPs.
- **IP / Netblock:** direcci√≥n de un host (ej. `203.0.113.10`) / rango (ej. `203.0.113.0/24`).
- **ASN (Autonomous System Number):** identificador de un operador de red; agrupa netblocks.
- **vHost (virtual host):** varios sitios web compartiendo una misma IP (se distinguen por el ‚ÄúHost‚Äù HTTP).
- **DMZ:** zona de red expuesta al exterior (‚Äútierra de nadie‚Äù entre internet y la red interna).
- **WAF (Web Application Firewall):** filtro de tr√°fico HTTP para proteger aplicaciones web.
- **IDS/IPS:** detecci√≥n/preven¬≠ci√≥n de intrusiones a nivel de red/sistema.
- **EDR:** defensa en endpoints (detecta comportamiento malicioso en hosts).
- **NAC:** controla qu√© dispositivos pueden entrar a la red.
- **CT logs (Certificate Transparency):** registros p√∫blicos de certificados TLS emitidos; revelan subdominios.
- **CNAME:** registro DNS que ‚Äúapunta‚Äù un nombre a otro (√∫til para descubrir servicios en la nube).

---

## üß≠ Los 3 niveles de enumeration
- **Infrastructure-based:** visi√≥n macro (dominios, IPs, proveedores, per√≠metro y defensas).
- **Host-based:** cada m√°quina como individuo (puertos, servicios, versiones, rutas web).
- **OS-based:** detalle interno del sistema (procesos, usuarios, permisos, configuraci√≥n).

> En un pentest externo empiezas en Infraestructura ‚Üí Host ‚Üí (si hay acceso) OS. En interno, puedes entrar directo a Host/OS.

---

## üß± Las 6 capas (qu√© es, por qu√© importa, c√≥mo lo hago, salida esperada)

### 1) Internet Presence
- **Qu√© es:** todo lo visible en internet: dominios/subdominios, IPs, rangos, cloud, sitios web.
- **Por qu√©:** delimita el **alcance real** y el mapa inicial.
- **C√≥mo:** whois, DNS (A/AAAA/MX/TXT/CNAME), CT logs, buscadores, Wayback, proveedores cloud.
- **Salida:** lista de dominios/subdominios resueltos a IP, rangos/ASN del cliente, posibles terceros.
- **Comandos ejemplo:**
  ```bash
  whois empresa.com | tee whois.txt
  dig NS empresa.com +short
  dig MX empresa.com +short
  dig TXT empresa.com +short          # SPF/DMARC ‚Üí proveedores de correo
  amass enum -passive -d empresa.com -o amass.txt
  subfinder -d empresa.com -all -silent | tee subfinder.txt
  cat amass.txt subfinder.txt | sort -u > subs.raw.txt
  dnsx -l subs.raw.txt -a -resp -o subs.resolved.txt   # host ‚Üí IP
  ```

### 2) Gateway
- **Qu√© es:** la ‚Äúpuerta‚Äù y defensa perimetral (firewalls, WAF, CDN, VPN, proxys, segmentaci√≥n).
- **Por qu√©:** define qu√© est√° filtrado, qu√© requisitos de acceso hay y d√≥nde puede haber ‚Äúhuecos‚Äù.
- **C√≥mo:** revisar cabeceras HTTP, respuestas de error, rutas de VPN, IPs de CDN, comportamiento a ‚Äúpayloads‚Äù inocuos.
- **Salida:** hip√≥tesis de defensas (WAF/CDN), presencia de VPN/proxy, puertos/servicios expuestos realmente.
- **Comandos ejemplo:**
  ```bash
  httpx -l <hosts> -status-code -title -tech-detect -follow-redirects -o webscan.txt
  curl -I https://portal.empresa.com            # cabeceras; ¬øhay Cloudflare? ¬øServer: ?
  dig CNAME portal.empresa.com +short           # ¬øapunta a *.cloudfront.net / *.azureedge.net?
  ```

### 3) Accessible Services
- **Qu√© es:** servicios a los que podemos llegar (HTTP(S), SSH, RDP, FTP, SMB, LDAP, etc.).
- **Por qu√©:** cada servicio abre caminos distintos (autenticaci√≥n, archivos, APIs).
- **C√≥mo:** escaneos medidos (TCP/UDP), banner grabbing, scripts seguros de nmap, herramientas espec√≠ficas por servicio.
- **Salida:** tabla servicio/puerto/versi√≥n/config. + posibles rutas web/endpoints.
- **Comandos ejemplo:**
  ```bash
  nmap -sS -Pn -T4 -p- <IP>                  # descubrir puertos (SYN sigiloso)
  nmap -sV -sC -O -p <puertos> <IP>          # versiones + scripts b√°sicos + SO
  nc -nv <IP> 22                             # banner SSH
  whatweb http://host/                       # fingerprinting tecnol√≥gico
  ```

### 4) Processes
- **Qu√© es:** tareas internas que ejecutan los servicios (procesos, colas, jobs, flujos de datos).
- **Por qu√©:** revelan **dependencias** y puntos de inyecci√≥n/escalada.
- **C√≥mo:** en externo: inferencias por tiempos de respuesta, rutas `/status/metrics`, documentaci√≥n. En interno/OS: `ps`, `systemctl`, logs.
- **Salida:** mapa ‚Äúservicio ‚Üí proceso ‚Üí datos (origen/destino)‚Äù. Endpoints administrativos.
- **Comandos ejemplo (si hay acceso):**
  ```bash
  # Linux (post‚Äëacceso)
  ps aux | grep -i <servicio>
  systemctl status <servicio>.service
  ss -tulpn                                   # sockets en escucha
  ```

### 5) Privileges
- **Qu√© es:** qui√©n puede hacer qu√© (usuarios, grupos, permisos, restricciones).
- **Por qu√©:** determina **l√≠mites** y oportunidades de **escalada**.
- **C√≥mo:** revisar permisos de archivos/servicios, cuentas de servicio, pol√≠ticas (AD, sudoers).
- **Salida:** matriz ‚Äúusuario/grupo ‚Üí permisos ‚Üí recursos‚Äù y posibles rutas de abuso.
- **Comandos ejemplo (si hay acceso):**
  ```bash
  id; groups                                  # usuario actual y grupos
  sudo -l                                     # comandos permitidos por sudo
  getcap -r / 2>/dev/null                     # capabilities en binarios
  ```

### 6) OS Setup
- **Qu√© es:** sistema operativo y su configuraci√≥n (tipo, parches, red, archivos sensibles).
- **Por qu√©:** refleja madurez de administraci√≥n y **debilidades base**.
- **C√≥mo:** fingerprinting desde fuera (TTL, banners), y desde dentro (versi√≥n kernel, paquetes, config).
- **Salida:** inventario de versi√≥n/parches, configuraciones inseguras, secretos en archivos.
- **Comandos ejemplo (si hay acceso):**
  ```bash
  uname -a && cat /etc/os-release             # versi√≥n de OS
  ip a && ip r                                # interfaces y rutas
  ls -la /etc | head                          # archivos interesantes de configuraci√≥n
  ```

---

## üîÅ Flujo de trabajo paso a paso (de 0 a un mapa utilizable)
1) **Recolecta presencia en internet (Capa 1):**
   ```bash
   whois empresa.com
   amass enum -passive -d empresa.com -o amass.txt
   subfinder -d empresa.com -all -silent | tee subfinder.txt
   cat amass.txt subfinder.txt | sort -u > subs.txt
   dnsx -l subs.txt -a -resp -o resolved.txt
   ```
   - **Salida:** `host ‚Üí IP`, posibles proveedores (por CNAME/TXT).

2) **Perfila el gateway (Capa 2):**
   ```bash
   httpx -l <(awk '{print $1}' resolved.txt) -status-code -title -tech-detect -o web.txt
   curl -I https://portal.empresa.com
   ```
   - **Interpreta:** ¬øCDN/WAF? ¬øredirecciones? ¬øcabeceras de seguridad?

3) **Enumera servicios (Capa 3):**
   ```bash
   # Por IP interesante
   nmap -sS -Pn -T4 -p- <IP>
   nmap -sV -sC -O -p <puertos> <IP> -oN nmap_<IP>.txt
   whatweb http://<host>/
   ```

4) **Infier¬≠e procesos (Capa 4):**
   - Busca `/status`, `/metrics`, `/admin`, colas (ej. RabbitMQ), cron, etc.
   - Analiza tiempos y respuestas para sospechar procesos backend.

5) **Mapa de privilegios (Capa 5):**
   - Si hay credenciales o sesiones, identifica permisos de cuentas de servicio/usuarios.

6) **Detalle de OS (Capa 6):**
   - Si consigues shell, levanta inventario (versi√≥n, parches, red, ficheros).

> En cada paso: **documenta** (CSV/MD) qu√© viste, por qu√© crees que est√° as√≠ y c√≥mo puede ayudarte despu√©s.

---

## üíª Comandos √∫tiles (con explicaci√≥n de flags)
```bash
# Nmap (descubrir puertos TCP r√°pidamente y con menos ruido)
nmap -sS -Pn -T4 -p- <IP>         # -sS: SYN scan; -Pn: no ping previo; -T4: m√°s r√°pido; -p-: todos los puertos

# Nmap (profundizar en lo descubierto)
nmap -sV -sC -O -p <puertos> <IP> # -sV: versi√≥n; -sC: scripts seguros por defecto; -O: SO; -p: puertos concretos

# Detecci√≥n tecnol√≥gica web
whatweb http://<host>/            # fingerprinting de CMS/servidor/plugins

# Banner grabbing manual
nc -nv <IP> 80
GET / HTTP/1.1
Host: <IP>

# DNS y CT logs (subdominios y proveedores)
dig MX empresa.com +short
dig TXT empresa.com +short        # SPF/DMARC ‚Üí proveedores de correo
dig CNAME sub.empresa.com +short  # ¬øapunta a servicios cloud?
amass enum -passive -d empresa.com -o amass.txt
subfinder -d empresa.com -all -silent | tee subfinder.txt
dnsx -l subs.txt -a -resp -o resolved.txt

# SMB/LDAP/RPC (si puertos abiertos)
smbclient -L //<IP> -U ""         # listar recursos compartidos (an√≥nimo)
enum4linux -a <IP>                # enum detallada SMB/NetBIOS
ldapsearch -x -h <IP> -s base namingcontexts

# SNMP (si 161/udp)
snmpwalk -v2c -c public <IP>

# HTTPx (perfilado masivo de hosts web)
httpx -l hosts.txt -status-code -title -tech-detect -follow-redirects -o webscan.txt
```

---

## üß™ Ejemplo guiado (mini‚Äëcaso)
1) Encuentras `vpn.empresa.com` y `portal.empresa.com` (Capa 1).  
2) `curl -I portal` muestra `Server: cloudflare` (Capa 2) ‚Üí posible WAF.  
3) `httpx` detecta t√≠tulo ‚ÄúLogin Portal‚Äù e `ASP.NET` (Capa 3).  
4) Wayback ense√±a `/admin` hist√≥rico ‚Üí proceso admin detr√°s (Capa 4).  
5) TXT de dominio incluye `sendgrid.net` ‚Üí cuentas de servicio de correo (Capa 5, sospecha).  
6) Objetivo para siguientes fases: enumerar rutas `/admin`, revisar headers, buscar subdominio `staging` v√≠a CT logs y validar si hay servicios menos protegidos (Capa 6 cuando haya acceso).

---

## üóíÔ∏è Errores comunes y c√≥mo evitarlos
- **Brute force temprano:** genera alertas/bloqueos ‚Üí primero mapea defensas.
- **No deduplicar fuentes:** mezcla OSINT ‚â† realidad; resuelve y valida.
- **No anotar:** sin evidencias, no hay narrativa ni priorizaci√≥n.
- **Confundir OSINT con enumeration activa:** separa actividades y permisos.
- **Ignorar lo ‚Äúinvisible‚Äù:** puertos filtrados/importantes pueden estar detr√°s de VPN o listas de control.

---

## üìå Resumen para memorizar
- 3 niveles: **Infraestructura ‚Üí Host ‚Üí OS**.
- 6 capas: **Internet Presence ‚Üí Gateway ‚Üí Accessible Services ‚Üí Processes ‚Üí Privileges ‚Üí OS Setup**.
- Cada capa responde: **qu√© es, por qu√© importa, c√≥mo lo detecto, qu√© entrego**.
- Evita ruido, documenta todo, y **itera**: cada hallazgo abre nuevas rutas.
