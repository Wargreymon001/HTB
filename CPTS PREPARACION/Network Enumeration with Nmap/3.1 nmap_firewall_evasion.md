# Firewall and IDS/IPS Evasion

## Objetivos del Módulo
- Entender cómo funcionan los **firewalls** y los sistemas de detección/prevenir intrusiones (**IDS/IPS**).
- Identificar cómo Nmap puede ser detectado o bloqueado por estos sistemas.
- Aprender técnicas para **evadir reglas de firewall e IDS/IPS**.
- Poner en práctica métodos como **ACK scan, decoys, uso de puertos de confianza y DNS proxying**.

---

## Firewalls
- Actúan como filtros de red que permiten, bloquean o ignoran paquetes según reglas predefinidas.  
- Pueden **dropear** paquetes (sin respuesta) o **rechazarlos** (con RST o ICMP errors como *Net Unreachable, Host Prohibited, Port Unreachable*).

---

## IDS / IPS
- **IDS**: monitorea el tráfico, detecta patrones de ataque y notifica.  
- **IPS**: además de detectar, bloquea automáticamente las conexiones sospechosas.  
- Ambos trabajan con **signaturas y patrones de tráfico**.

---

## Escaneo con Nmap y Firewalls

### Escaneo SYN (-sS)
```bash
sudo nmap 10.129.2.28 -p 21,22,25 -sS -Pn -n --disable-arp-ping --packet-trace
```
- Respuestas:  
  - Puerto 22 responde con **SYN-ACK** (abierto).  
  - Puerto 21 y 25 marcados como **filtered**.

---

### Escaneo ACK (-sA)
```bash
sudo nmap 10.129.2.28 -p 21,22,25 -sA -Pn -n --disable-arp-ping --packet-trace
```
- Puerto 22 responde con **RST** → **unfiltered**.  
- Puerto 25 no responde → **filtered**.

**Conclusión:**  
El escaneo con ACK es más difícil de filtrar porque los paquetes con **ACK** suelen atravesar firewalls que solo bloquean SYN.

---

## Detección de IDS/IPS
- Difícil de identificar directamente porque son sistemas pasivos.  
- Una forma práctica: realizar un escaneo agresivo desde una IP y comprobar si luego la dirección queda **bloqueada**.  
- Si ocurre, es probable que exista un **IPS**.

---

## Técnicas de Evasión en Nmap

### Uso de **Decoys (-D)**
```bash
sudo nmap 10.129.2.28 -p 80 -sS -Pn -n --disable-arp-ping --packet-trace -D RND:5
```
- Genera 5 IPs aleatorias que se mezclan con la IP real.
- Dificulta la atribución del escaneo al atacante real.
- Requiere que los decoys estén vivos (evitar *SYN flood* innecesario).

---

### Spoofing de IP de origen (-S)
```bash
sudo nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200 -e tun0
```
- Simula que el escaneo proviene de otra IP.  
- Puede revelar reglas de firewall basadas en origen.

---

### Uso de Puertos de Confianza
Algunos firewalls permiten paquetes provenientes de **puertos legítimos** como el `53` (DNS).  
```bash
sudo nmap 10.129.2.28 -p50000 -sS -Pn -n --disable-arp-ping --packet-trace --source-port 53
```
- Resultado: puerto 50000 detectado como **open** (evadiendo filtrado).

Incluso se puede abrir conexión con **Netcat**:
```bash
ncat -nv --source-port 53 10.129.2.28 50000
```
→ Respuesta: `220 ProFTPd`

---

## Firewall and IDS/IPS Evasion Labs

### Objetivos del Laboratorio
- Practicar técnicas de evasión de firewalls y sistemas IDS/IPS.
- Escanear objetivos de manera **silenciosa** para evitar bloqueos.
- Detectar qué reglas de firewall existen y cómo superarlas.
- Aplicar **decoys, spoofing de IPs, y puertos de confianza** para encontrar servicios.

### Enunciado
Se nos presentan varios escenarios donde los sistemas están protegidos con **firewall rules** y **IDS/IPS**.  
Nuestro objetivo es:
1. Identificar los puertos filtrados y sus reglas.  
2. Evadir la detección mediante técnicas aprendidas.  
3. Obtener la información del sistema de forma **sigilosa**.  
4. Reportar qué método permitió **bypassear las defensas**.

---
