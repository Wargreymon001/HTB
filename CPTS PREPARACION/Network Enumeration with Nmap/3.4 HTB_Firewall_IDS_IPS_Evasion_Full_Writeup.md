
# Firewall and IDS/IPS Evasion Lab - Writeup Completo

Este documento describe paso a paso la resolución del laboratorio **Firewall and IDS/IPS Evasion** en HackTheBox Academy, pensado como preparación para el **CPTS**.  
Se detalla todo el proceso desde el **reconocimiento inicial sin pistas** hasta la evasión del firewall/IPS y la obtención de acceso.

---

## 🔎 1. Reconocimiento Inicial

Lo primero es identificar qué servicios/puertos están abiertos en la máquina objetivo.  
Iniciamos con un escaneo de puertos TCP comunes usando **Nmap**:

```bash
sudo nmap -sS -Pn -p- --min-rate 1000 -n 10.129.27.38
```

- `-sS`: Escaneo SYN (rápido y sigiloso).  
- `-Pn`: Ignorar ping (host discovery deshabilitado).  
- `-p-`: Todos los puertos (1-65535).  
- `--min-rate 1000`: Velocidad mínima de 1000 paquetes por segundo.  
- `-n`: Sin resolución DNS.  

📌 Resultado inicial: la mayoría de los puertos aparecen **filtered** (filtrados). Esto sugiere que hay **firewall/IPS** de por medio.  
Pero detectamos actividad en el **puerto 50000/tcp**, aunque aparece como *filtered*.

---

## 🚧 2. Identificación de Firewall/IPS

Para entender cómo responde el firewall, probamos distintos tipos de escaneo:

### Escaneo SYN (normal)
```bash
sudo nmap -sS -Pn -p 50000 -n 10.129.27.38
```
📌 Resultado: `filtered` → el firewall está bloqueando o descartando.

### Escaneo ACK (detección de reglas de firewall)
```bash
sudo nmap -sA -Pn -p 50000 -n 10.129.27.38
```
📌 Resultado: también `filtered`.  
Esto confirma que **hay reglas activas de firewall** sobre el puerto.

### Fragmentación de paquetes
```bash
sudo nmap -sS -Pn -p 50000 -f --mtu 24 10.129.27.38
```
📌 Resultado: sigue `filtered`.  
El firewall probablemente reensambla paquetes y no deja pasar.

### Uso de Decoys
```bash
sudo nmap -sS -Pn -p 50000 -D RND:5 10.129.27.38
```
📌 Resultado: sigue `filtered`.  
El firewall ignora paquetes spoofeados.

---

## 🕵️ 3. Técnicas de Evasión (Clave)

Sabemos que algunos firewalls permiten ciertos **puertos confiables**, como `53/tcp` (DNS).  
Podemos usar ese puerto como **source-port** en Nmap.

### Escaneo con `--source-port 53`
```bash
sudo nmap -sS -Pn -p 50000 -n --disable-arp-ping --packet-trace --source-port 53 10.129.27.38
```
📌 Resultado:  
```
50000/tcp open ibm-db2
```

💡 **Éxito**: logramos evadir el firewall usando el puerto 53 como origen.  
Esto ocurre porque el firewall probablemente confía en tráfico DNS.

---

## 🛠 4. Detección de Servicios

Probamos con **detección de versión**:

```bash
sudo nmap -sV -Pn -p 50000 --source-port 53 --version-all --version-trace 10.129.27.38
```
📌 Resultado: `tcpwrapped`.  
El servicio está protegido y no revela versión a Nmap.

---

## 📡 5. Conexión Manual con Netcat

Ya que Nmap no nos da versión, probamos directamente con **ncat** para ver la respuesta del servicio.

```bash
sudo ncat -nv --source-port 53 10.129.27.38 50000
```

📌 Resultado:  
```
220 HTB{xxxxxxxxx}
```

Esto nos da la **flag** del laboratorio.  
El banner que devuelve el servicio confirma que hemos evadido correctamente el firewall y accedido al servicio detrás de él.

---

## ✅ 6. Conclusión

- Sin evasión → el puerto aparece como `filtered`.  
- Con `--source-port 53` → logramos abrir el puerto y conectarnos.  
- El firewall/IPS estaba configurado para permitir tráfico DNS, lo cual aprovechamos.  
- La conexión con `ncat` reveló el banner y la flag.

---

## 🔑 Comandos Clave Usados

```bash
# Escaneo completo inicial
sudo nmap -sS -Pn -p- --min-rate 1000 -n 10.129.27.38

# SYN scan básico
sudo nmap -sS -Pn -p 50000 -n 10.129.27.38

# ACK scan
sudo nmap -sA -Pn -p 50000 -n 10.129.27.38

# Fragmentación de paquetes
sudo nmap -sS -Pn -p 50000 -f --mtu 24 10.129.27.38

# Decoys
sudo nmap -sS -Pn -p 50000 -D RND:5 10.129.27.38

# Evasión con puerto DNS (clave)
sudo nmap -sS -Pn -p 50000 -n --source-port 53 10.129.27.38

# Conexión manual
sudo ncat -nv --source-port 53 10.129.27.38 50000
```

---

## 📝 Nota para Examen CPTS

Este laboratorio ilustra perfectamente cómo un firewall puede ser **bypasseado** usando:
- Puertos confiables (DNS, HTTP, HTTPS).  
- Modificación de source-port.  
- Técnicas de stealth scanning.

Para examen: **recuerda siempre probar source-port 53/80/443 si un puerto parece filtrado.**

