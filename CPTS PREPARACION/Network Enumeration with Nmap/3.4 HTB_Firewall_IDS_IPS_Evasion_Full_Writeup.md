
# Firewall and IDS/IPS Evasion Lab - Writeup Completo

Este documento describe paso a paso la resoluciÃ³n del laboratorio **Firewall and IDS/IPS Evasion** en HackTheBox Academy, pensado como preparaciÃ³n para el **CPTS**.  
Se detalla todo el proceso desde el **reconocimiento inicial sin pistas** hasta la evasiÃ³n del firewall/IPS y la obtenciÃ³n de acceso.

---

## ğŸ” 1. Reconocimiento Inicial

Lo primero es identificar quÃ© servicios/puertos estÃ¡n abiertos en la mÃ¡quina objetivo.  
Iniciamos con un escaneo de puertos TCP comunes usando **Nmap**:

```bash
sudo nmap -sS -Pn -p- --min-rate 1000 -n 10.129.27.38
```

- `-sS`: Escaneo SYN (rÃ¡pido y sigiloso).  
- `-Pn`: Ignorar ping (host discovery deshabilitado).  
- `-p-`: Todos los puertos (1-65535).  
- `--min-rate 1000`: Velocidad mÃ­nima de 1000 paquetes por segundo.  
- `-n`: Sin resoluciÃ³n DNS.  

ğŸ“Œ Resultado inicial: la mayorÃ­a de los puertos aparecen **filtered** (filtrados). Esto sugiere que hay **firewall/IPS** de por medio.  
Pero detectamos actividad en el **puerto 50000/tcp**, aunque aparece como *filtered*.

---

## ğŸš§ 2. IdentificaciÃ³n de Firewall/IPS

Para entender cÃ³mo responde el firewall, probamos distintos tipos de escaneo:

### Escaneo SYN (normal)
```bash
sudo nmap -sS -Pn -p 50000 -n 10.129.27.38
```
ğŸ“Œ Resultado: `filtered` â†’ el firewall estÃ¡ bloqueando o descartando.

### Escaneo ACK (detecciÃ³n de reglas de firewall)
```bash
sudo nmap -sA -Pn -p 50000 -n 10.129.27.38
```
ğŸ“Œ Resultado: tambiÃ©n `filtered`.  
Esto confirma que **hay reglas activas de firewall** sobre el puerto.

### FragmentaciÃ³n de paquetes
```bash
sudo nmap -sS -Pn -p 50000 -f --mtu 24 10.129.27.38
```
ğŸ“Œ Resultado: sigue `filtered`.  
El firewall probablemente reensambla paquetes y no deja pasar.

### Uso de Decoys
```bash
sudo nmap -sS -Pn -p 50000 -D RND:5 10.129.27.38
```
ğŸ“Œ Resultado: sigue `filtered`.  
El firewall ignora paquetes spoofeados.

---

## ğŸ•µï¸ 3. TÃ©cnicas de EvasiÃ³n (Clave)

Sabemos que algunos firewalls permiten ciertos **puertos confiables**, como `53/tcp` (DNS).  
Podemos usar ese puerto como **source-port** en Nmap.

### Escaneo con `--source-port 53`
```bash
sudo nmap -sS -Pn -p 50000 -n --disable-arp-ping --packet-trace --source-port 53 10.129.27.38
```
ğŸ“Œ Resultado:  
```
50000/tcp open ibm-db2
```

ğŸ’¡ **Ã‰xito**: logramos evadir el firewall usando el puerto 53 como origen.  
Esto ocurre porque el firewall probablemente confÃ­a en trÃ¡fico DNS.

---

## ğŸ›  4. DetecciÃ³n de Servicios

Probamos con **detecciÃ³n de versiÃ³n**:

```bash
sudo nmap -sV -Pn -p 50000 --source-port 53 --version-all --version-trace 10.129.27.38
```
ğŸ“Œ Resultado: `tcpwrapped`.  
El servicio estÃ¡ protegido y no revela versiÃ³n a Nmap.

---

## ğŸ“¡ 5. ConexiÃ³n Manual con Netcat

Ya que Nmap no nos da versiÃ³n, probamos directamente con **ncat** para ver la respuesta del servicio.

```bash
sudo ncat -nv --source-port 53 10.129.27.38 50000
```

ğŸ“Œ Resultado:  
```
220 HTB{xxxxxxxxx}
```

Esto nos da la **flag** del laboratorio.  
El banner que devuelve el servicio confirma que hemos evadido correctamente el firewall y accedido al servicio detrÃ¡s de Ã©l.

---

## âœ… 6. ConclusiÃ³n

- Sin evasiÃ³n â†’ el puerto aparece como `filtered`.  
- Con `--source-port 53` â†’ logramos abrir el puerto y conectarnos.  
- El firewall/IPS estaba configurado para permitir trÃ¡fico DNS, lo cual aprovechamos.  
- La conexiÃ³n con `ncat` revelÃ³ el banner y la flag.

---

## ğŸ”‘ Comandos Clave Usados

```bash
# Escaneo completo inicial
sudo nmap -sS -Pn -p- --min-rate 1000 -n 10.129.27.38

# SYN scan bÃ¡sico
sudo nmap -sS -Pn -p 50000 -n 10.129.27.38

# ACK scan
sudo nmap -sA -Pn -p 50000 -n 10.129.27.38

# FragmentaciÃ³n de paquetes
sudo nmap -sS -Pn -p 50000 -f --mtu 24 10.129.27.38

# Decoys
sudo nmap -sS -Pn -p 50000 -D RND:5 10.129.27.38

# EvasiÃ³n con puerto DNS (clave)
sudo nmap -sS -Pn -p 50000 -n --source-port 53 10.129.27.38

# ConexiÃ³n manual
sudo ncat -nv --source-port 53 10.129.27.38 50000
```

---

## ğŸ“ Nota para Examen CPTS

Este laboratorio ilustra perfectamente cÃ³mo un firewall puede ser **bypasseado** usando:
- Puertos confiables (DNS, HTTP, HTTPS).  
- ModificaciÃ³n de source-port.  
- TÃ©cnicas de stealth scanning.

Para examen: **recuerda siempre probar source-port 53/80/443 si un puerto parece filtrado.**

